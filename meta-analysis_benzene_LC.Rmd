---
title: "meta-analysis benzene-LC studies"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

##################### 

**Any question? email w.wan@uu.nl or charleswanwen@gmail.com**

#####################


This script follows the systematic search of papers on the effect of occupational benzene exposure on lung cancer up till 2024, and stands for the formal meta-analysis (MA) of the risk estimates extracted from these studies. Details for the data extracted and the screening process are recorded in the associated paper. The main structure of the following codes follows:


1. for studies only reported exposure within several exposure categories without reporting ever-exposure effect, collapse risk estimates with fixed-effect MA
2. ever exposure MA [main analysis, fig 2]
3. do various sensitivity analyses:
  3.1 Meta-regression over three studies that reported original benzene exposure scales (with ref to https://ehp.niehs.nih.gov/doi/10.1289/ehp.1306880)
  3.2 break-up pooled studies from Wan et al. (2024) and include these as individual studies to be included with other studies for MA on ever-exposure
  3.3 do various subgroup analyses 
    3.3.1 effect sizes from highest vs. lowest exposure category used
    3.3.2 overall quality (low, moderate, high)
    3.3.3 exposure assessment quality (low, medium, high)
    3.3.4 whether smoking was adjusted
    3.3.5 stratify by continent
  3.4 combine all results from 3.3 to produce one figure (fig 3)  
  3.5 pub bias
4. ROB assessment scores (visualisation of)  

```{r load packages, include=FALSE}

require(dplyr)
require(tidyverse)
require(meta)
require(ggplot2)
require(readxl)
require(glmnet)
require(ggforce)
require(dosresmeta)
require(rms)
require(ggforce)
require(ggsci)
require(robvis)
library(tibble)
library(tidyr)
library(ggpattern)
require(ggsci)

```



#1. calculate the ever-exposure estimates from studies with multiple exposure categories group that did not report

For the following studies:

- Babigumira et al. (2023)
- Collins et al. (2003)
- Mattei et al. (2016)

please note for Koh et al. (2011)_///note: not to be pooled, estimates of all workers will be used instead.


```{r}

# record data

mult_grp_dat <- tribble(~study_label, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type, ~study, ~comp_grp,
               "Babigumira_q1", 1.47, 0.9, 2.4, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal", 
               "Babigumira_q2", 1.30, 0.75, 2.26, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal",
               "Babigumira_q3", 1.18, 0.64, 2.15, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal",
               "Babigumira_q4", 1.15, 0.61, 2.16, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal",
###
               "Collins_<1", 1.1, 0.7, 1.5, 32, "cohort", "industry-based", "Collins et al. (2003)", "external",
               "Collins_>1-6", 1.3, 1.0, 1.8, 39, "cohort", "industry-based", "Collins et al. (2003)", "external",
               "Collins_>6", 1.6, 1.2, 2.1, 55, "cohort", "industry-based", "Collins et al. (2003)", "external",
###
               # "Mattei_low", 1.01, 0.59, 1.71, 108, "case-control", "population-based", "Mattei et al. (2016)",  "internal",
               # "Mattei_medium", 0.86, 0.45, 1.65, 106, "case-control", "population-based", "Mattei et al. (2016)",  "internal",
               # "Mattei_high", 0.95, 0.44, 2.04, 129, "case-control", "population-based", "Mattei et al. (2016)",  "internal",
###
               "Wan_<1", 1.12, 1.03, 1.21, 2190, "case-control", "population-based", "Wan et al. (2023)", "internal",
               "Wan_1-5", 1.17, 1.08, 1.27, 2553, "case-control", "population-based", "Wan et al. (2023)", "internal",
               "Wan_>5", 1.32, 1.18, 1.48, 1095, "case-control", "population-based", "Wan et al. (2023)", "internal",
)

ma_collap <- metagen(data = mult_grp_dat,
                   TE = log(mult_grp_dat$rr),
                   studlab = study_label,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(mult_grp_dat$lower_ci),
                   upper = log(mult_grp_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = study
                   )

# require(grid)

forest(ma_collap, xlim = c(0.5,3), pooled.totals = F,  layout = "RevMan5", random = T, common = T, subgroup = T, overall = F, prediction = T, prediction.subgroup = T, study.results = F)
# grid.text("Meta-analysis of ever-benzene exposure on lung cancer risk for all studies included in the IARC Monograph on Benzene, stratified by population types", .5, 0.96, gp=gpar(cex=1.2))



```


#2. ever exposure MA [main analysis, fig 2]


```{r}

dat_ever <- tribble(~study, ~year, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,  ~comp_grp, ~study_type, ~study_quality, ~exposure_quality, ~region, ~sex, ~smoking,
               "Wong et al. (1987)", 1987, 1.29, 1.00, 1.65, 18, "Cohort", "Industry-based", "external", "Cohort studies with external comparison",  "Moderate",  "Moderate", "USA", "only male", "not adjusted",
               # for collins (2003), the sum o/e is calculated (252/191.8) to obtain ever_exp estimates
               "Collins et al. (2003)", 2003, 1.31, 1.16, 1.48, 252, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "High", "USA", "mixed", "not adjusted",
               "Sorahan et al. (2005)", 2005, 1.19, 1.06, 1.34, 293, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "low", "Europe", "mixed", "not adjusted",
               "Hoshuyama et al. (2006)",2006, 1.04, 1.00, 1.08, 11, "Cohort", "Industry-based", "internal", "Cohort studies with internal comparison", "Moderate", "Moderate", "Asia", "only male", "not adjusted",
               "Koh et al. (2011)", 2011, 0.35, 0.11, 0.83, 6, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "Low", "Asia", "only male", "not adjusted",
               "Koh et al. (2014)", 2014, 0.73, 0.24, 1.71, 5, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Low", "Low", "Asia", "only male","not adjusted",
               "Linet et al. (2015)",2015, 1.5, 1.2, 1.9, 351, "Cohort", "Industry-based", "internal", "Cohort studies with internal comparison", "High", "High", "Asia", "mixed","not adjusted",
               "Collins et al. (2015)", 2015, 1.05, 0.89, 1.24, 146, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "High", "USA", "mixed","not adjusted",
               # for Babigumira 2023, fixed-effect MA for three exp categories was used to estimate the ever_exp est.
               "Babigumira et al. (2023)",2023, 1.29, 0.98, 1.71, 292, "Cohort", "Industry-based", "internal", "Cohort studies with internal comparison", "High", "High", "Europe", "only male","adjusted",
               "Wan et al. (2024)", 2024, 1.17, 1.10, 1.24, 5838, "Case-control", "population-based", "internal",  "Case-control", "high", "Moderate", "Europe", "mixed","adjusted",
               # for mattei 2016, fixed-effect MA for three exp categories was used to estimate the ever_exp est.
               # "Mattei et al. (2016)", 0.95, 0.66, 1.36, 343, "case-control", "population-based", "internal", "case-control", "high", "low", "Europe", "mixed","adjusted",
               "McHugh et al. (2010)", 2010, 1.13, 0.69, 1.86, 38, "Case-control", "population-based", "internal","Case-control", "Moderate", "low", "USA", "mixed","adjusted",
               "Greenland et al. (1994)",1994, 0.58, 0.31, 1.07, -99999, "Case-control", "Industry-based", "internal", "Case-control", "Moderate", "Moderate", "USA", "only male","not adjusted",
               "DeMoulin et al. (2024)", 2024, 1, 0.9, 1.2, 221, "Cohort", "population-based", "internal", "Cohort studies with internal comparison", "High", "Moderate", "Asia", "only male","adjusted",

               ## excluded wong study 
               # "Wong et al (1993)_land", 0.66, 0.57, 0.77, 165, "cohort", "industry-based", "external", "cohort study with external comparison", "x", "x", "x", "men", "not adjusted",
               # "Wong et al (1993)_marine", 1.07, 0.94, 1.21, 208, "cohort", "industry-based", "external", "cohort study with external comparison", "x", "x", "x", "men", "not adjusted",
               # "Wong et al (1993)_calculated_combined", 0.8394, 0.7574, 0.9279, 373, "cohort", "industry-based", "external", "cohort study with external comparison", "x", "x", "x", "men", "not adjusted",
               ) %>% 
    mutate(across(7:15, ~ str_replace(., "^.", toupper)))

dat_ever$study_quality <- factor(dat_ever$study_quality,
                                 levels = c("High", "Moderate", "Low"))

dat_ever$exposure_quality <- factor(dat_ever$exposure_quality,
                                 levels = c("High", "Moderate", "Low"))


order_dat <- dat_ever[order(dat_ever$year),]

ma_ever <- metagen(data = order_dat,
                   TE = log(order_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(order_dat$lower_ci),
                   upper = log(order_dat$upper_ci),
                   hakn = TRUE
                   # subgroup = study_type #vary this so various stratification can be made
                   )
# ma_ever$studlab <- "Study"

forest(ma_ever,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       leftcols = c("studlab", "seTE"),
       just = "left")


summary(ma_ever)


```


#3. do various sensitivity analyses:

##3.1 Meta-regression over studies that reported original benzene exposure scales

mid-point was used to except for the highest exp category, where 5/3 * lower bound will be used.

```{r}

dat_metareg <- tribble(~study, ~exp, ~RR, ~lower_ci, ~upper_ci, ~case, ~N, ~type,
                       "Babigumira et al. (2023)", 0, 1, NA, NA,  112, 767, "ci",
                       "Babigumira et al. (2023)", 0.008, 1.47, 0.90, 2.40,  85, 417, "ci",
                       "Babigumira et al. (2023)", 0.042, 1.30, 0.75, 2.26,  72, 417, "ci",
                       "Babigumira et al. (2023)", 0.120, 1.18, 0.64, 2.15, 63, 417, "ci",
                       "Babigumira et al. (2023)", 0.285, 1.15, 0.61, 2.16, 67, 416, "ci",
                       "Collins et al. (2003)", 0, 1.3, 1.1, 1.5, 126, 224.5, "ci",
                       "Collins et al. (2003)", 0.5, 1.1, 0.70, 1.50, 32, 62, "ci",
                       "Collins et al. (2003)", 3.5, 1.3, 1.00, 1.80, 39, 68, "ci",
                       "Collins et al. (2003)", 10, 1.6, 1.20, 2.10, 55, 89.3, "ci",
                       "Wan et al. (2024)", 0, 1, NA, NA, 6491,  15957, "cc", 
                       "Wan et al. (2024)", 0.5, 1.12, 1.03, 1.21, 2190, 4739, "cc",
                       "Wan et al. (2024)", 3, 1.17,  1.08, 1.27, 2553, 5251, "cc",
                       "Wan et al. (2024)", 8.3, 1.32, 1.18, 1.48, 1095, 2101, "cc",
                       # "DeMoulin et al. (2024)", 0, 1.0, NA, NA, 924, 48336, "ci",
                       # "DeMoulin et al. (2024)", 31.15, 1.0, 0.8, 1.3, 109, 6600, "ci",
                       # "DeMoulin et al. (2024)", 117, 0.8, 0.6, 1.0, 44, 3970, "ci",
                       # "DeMoulin et al. (2024)", 286.7, 1.2, 1.0, 1.6, 68, 2471, "ci",
) %>% 
  mutate(logrr = log(RR)) %>% 
  mutate(se = log(upper_ci) - log(lower_ci) / (2 * 1.96)) %>% 
  mutate(se = if_else(exp == 0, NA, se)) # this makes the control group se == 0, for the calculation of cov matrix

head(dat_metareg)


#obtain log-linear function

knots <- quantile(dat_metareg$exp, c(0.2, 0.5, 0.8))

fit <- dosresmeta(formula = logrr ~ rcs(exp, knots), 
                  se = se,
                  id = study, 
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "reml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg, proc = "1stage"
                  )

fit_lin <- dosresmeta(formula = logrr ~ exp,
                  se = se,
                  id = study,
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "reml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg, proc = "1stage"
                  )
summary(fit)
summary(fit_lin)

newdata <- data.frame(exp <- seq(0, 10.2, 0.01))
# 
# newdata$study = "Babigumira et al. (2023)"



pred_val <- predict(fit, newdata = newdata, expo = T) # transform back to original RR scale
require(ggsci)

# Plot the data with error bars, log-linear fit, and SE
ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_val, aes(x = `rcs(exp, knots)exp`, y = pred), color = "blue") +
  geom_ribbon(data = pred_val, aes(x = `rcs(exp, knots)exp`, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +
    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()



# for linear fit
pred_val_lin <- predict(fit_lin, newdata = newdata, expo = T) # transform back to original RR scale

ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_val_lin, aes(x = exp, y = pred), color = "blue") +
  geom_ribbon(data = pred_val_lin, aes(x = exp, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +
    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()



```

additional meta-reg analysis to obtain model fit based on the ML method
```{r}

fit <- dosresmeta(formula = logrr ~ rcs(exp, knots), 
                  se = se,
                  id = study, 
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "ml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg, intercept = F, proc = "1stage",
                  )

fit_lin <- dosresmeta(formula = logrr ~ exp,
                  se = se,
                  id = study,
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "ml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg,intercept = F, proc = "1stage",
                  )

summary(fit)
summary(fit_lin)


```

##3.2 break-up pooled studies from Wan et al. (2024) and include these as individual studies to be included with other studies for MA on ever-exposure

```{r}

dat_incl_syn <- dat_ever %>% 
  select(study, rr, lower_ci, upper_ci) %>% 
  rbind(tribble(~study, ~rr, ~lower_ci, ~upper_ci,
                "AUT", 1.28, 1.08, 1.51,
                "EAGLE", 0.98, 0.82, 1.18,
                "HdA", 1.33, 0.97, 1.83,
                "ICARE", 1.2, 1.04, 1.38,
                "INCO_UK", 1.04, 0.73, 1.49,
                "LUCAS", 1.07, 0.82, 1.4,
                "Montreal", 0.98, 0.78, 1.24,
                "Morgen", 3.59,  1.22, 10.58,
                "Turin/Veneto", 1.13, 0.84, 1.54,
                "Capua", 1.31, 0.9, 1.9,
                "INCO_CR", 1.24, 0.83, 1.87,
                "INCO_HU", 1.07, 0.72, 1.6,
                "INCO_PO", 0.93, 0.71, 1.21,
                "INCO_RO", 2.14, 1.21, 3.8,
                "INCO_RU", 1.06, 0.79, 1.44,
                "INCO_SL", 1.28, 0.83, 1.98,
                "LUCA", 0.91, 0.51, 1.62,
                "Paris", 0.99, 0.37, 2.63,
                "Rome", 1.25, 0.73, 2.14,
                "Toronto", 1.51, 1.04, 2.18,
                )) %>% 
  filter(!study == "Wan et al. (2024)")

dat_incl_syn$study[13:32] <- paste0("SYNERGY-", dat_incl_syn$study[13:32])



ma_ever_incl.syn <- metagen(data = dat_incl_syn,
                   TE = log(dat_incl_syn$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_incl_syn$lower_ci),
                   upper = log(dat_incl_syn$upper_ci),
                   hakn = TRUE
                   )

forest(ma_ever_incl.syn,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       leftcols = c("studlab", "seTE"),
       just = "left")



```



##3.3 do various subgroup analyses 

  3.3 do various subgroup analyses 
    3.3.0 study design (external, internal, cohort, case-control)
    3.3.1 effect sizes from highest vs. lowest exposure category used
    3.3.2 overall quality (low, moderate, high)
    3.3.3 exposure assessment quality (low, medium, high)
    3.3.4 whether smoking was adjusted
    3.3.5 stratify by continent
  3.4 combine all results from 3.3 to produce one figure (fig 3)  
  3.5 pub bias


###3.3.0 study design (external, internal, cohort, case-control)

```{r design}


order_dat <- dat_ever[order(dat_ever$year),] %>% 
  mutate(study_type = factor(order_dat$study_type,
                             levels = c("Cohort studies with external comparison", "Cohort studies with internal comparison", "Case-control" )))

ma_ever_2 <- metagen(data = order_dat,
                   TE = log(order_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(order_dat$lower_ci),
                   upper = log(order_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = study_type #vary this so various stratification can be made
                   )
# ma_ever$studlab <- "Study"

forest(ma_ever_2,
       xlim = c(0.5,2.5), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       subgroup.name = "",
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")


summary(ma_ever_2)


```



```{r by design cohort vs cc}


order_dat <- dat_ever[order(dat_ever$year),] %>% 
  mutate(study_type = factor(order_dat$study_type,
                             levels = c("Cohort studies with external comparison", "Cohort studies with internal comparison", "Case-control" )))

ma_ever_2 <- metagen(data = order_dat,
                   TE = log(order_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(order_dat$lower_ci),
                   upper = log(order_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = design #vary this so various stratification can be made
                   )
# ma_ever$studlab <- "Study"

forest(ma_ever_2,
       xlim = c(0.5,2.5), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       subgroup.name = "",
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")


summary(ma_ever_2)


```

###3.3.1 Effect sizes from highest vs. lowest exposure category used

```{r low exposure}

# 
dat_low <- tribble(~study, ~year, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
               "Wong et al. (1987): sporadic exposure", 1987, 1.46, 0.86, 2.3, 18, "cohort", "industry-based",
               "Collins et al. (2003): low exposure", 2003, 1.1, 0.7, 1.5, 32, "cohort", "industry-based",
               "Sorahan et al. (2005)", 2005, 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
               "Hoshuyama et al. (2006)",2006, 1.04, 1.00, 1.08, 11, "cohort", "industry-based",
               "Koh et al. (2011)", 2011, 0.35, 0.11, 0.83, 6, "cohort", "industry-based",
               "Koh et al. (2014)", 2014, 0.73, 0.24, 1.71, 5, "cohort", "industry-based",
               "Linet et al. (2015)", 2015, 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
               "Collins et al. (2015)", 2015, 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
               "Babigumira et al. (2023): low exposure",2023,  1.47, 0.9, 2.4, -9999, "cohort", "industry-based",
               "Wan et al. (2024): low exposure",2024, 1.12, 1.03, 1.21, 12329, "case-control", "population-based",
               # "Mattei et al. (2016)_low", 1.01, 0.59, 1.71, 129, "case-control", "population-based",
               "McHugh et al. (2010)",2010,  1.13, 0.69, 1.86, 38, "case-control", "population-based",
               "Greenland et al. (1994)", 1994, 0.58, 0.31, 1.07, -99999, "case-control", "industry-based",
                "DeMoulin et al. (2024): low exposure", 2024, 1.0, 0.8, 1.3, 109, "cohort", "population-based")

dat_low <- dat_low[order(dat_low$year),]

#
meta_dat1 <- metagen(data = dat_low,
                   TE = log(dat_low$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_low$lower_ci),
                   upper = log(dat_low$upper_ci),
                   hakn = TRUE
                   )

forest(meta_dat1,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")


```


```{r high exposure}

dat_high <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
               "Wong et al. (1987)", 1.25, 0.91, 1.66, 65, "cohort", "industry-based",
               "Collins et al. (2003): high exposure group", 1.6, 1.2, 2.1, 55, "cohort", "industry-based",
               "Sorahan et al. (2005)", 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
               "Hoshuyama et al. (2006)", 1.04, 1.00, 1.08, 11, "cohort", "industry-based",
               "Koh et al. (2011): high exposure group", 1.42, 0.52, 3.09, 6, "cohort", "industry-based",
               "Koh et al. (2014)", 0.73, 0.24, 1.71, 5, "cohort", "industry-based",
               "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
               "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
               "Babigumira et al. (2023): high exposure group", 1.15, 0.61, 2.16, -9999, "cohort", "industry-based",
               "Wan et al. (2024): high exposure group", 1.32, 1.18, 1.48, 12329, "case-control", "population-based",
               # "Mattei et al. (2016)", 0.95, 0.44, 2.04, 129, "case-control", "population-based",
               "McHugh et al. (2010)", 1.13, 0.69, 1.86, 38, "case-control", "population-based",
               "Greenland et al. (1994)", 0.58, 0.31, 1.07, -99999, "case-control", "industry-based",
               "DeMoulin et al. (2024): high exposure group", 1.5, 1.1, 2, 39, "cohort", "population-based"

               ) %>% 
  as.data.frame() %>% 
  cbind(dat_ever$year) %>% 
  rename(year = colnames(dat_high)[8])

dat_high <- dat_high[order(dat_high$year),]

meta_dat2 <- metagen(data = dat_high,
                   TE = log(dat_high$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_high$lower_ci),
                   upper = log(dat_high$upper_ci),
                   hakn = TRUE
                   )

forest(meta_dat2,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")

```


###3.3.2-5 subgroup (batch producing)
    3.3.2 overall quality (low, moderate, high)
    3.3.3 exposure assessment quality (low, medium, high)
    3.3.4 whether smoking was adjusted
    3.3.5 stratify by continent

```{r}

glimpse(dat_ever)

subgroup <- c("type", "study_quality", "exposure_quality", "sex", "smoking", "region")

dat_ever$region <- ifelse(dat_ever$region == "USA", "North America", dat_ever$region)


for (i in subgroup) {
  
ma_ever_sub <- metagen(data = dat_ever,
                   TE = log(dat_ever$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_ever$lower_ci),
                   upper = log(dat_ever$upper_ci),
                   hakn = TRUE,
                   subgroup = eval(parse(text = paste0(i))) 
                   )
# ma_ever$studlab <- "Study"
 file_name <- paste0("forest_plot_", i, ".png")
  
  # Open the PNG device
  png(file_name, width = 700, height = 600)
  
forest(ma_ever_sub,
       xlim = c(0.5,2.5), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       subgroup.name = "",
       col.subgroup = "black",
       # leftcols = c("studlab", "TE","seTE"),
       just = "left")

dev.off()
}



```


  3.4 combine all results from 3.3 to produce one figure (fig 3)  
  3.5 pub bias

##3.4 combine subgroup results

```{r}

sub_result <- tribble(~sub, ~group, ~rr, ~lower_ci, ~upper_ci,
                      "Study design", "Cohort (n=10)", 1.15, 1.01, 1.32,
                      "Study design", "Cohort studies with external comparison (n=6)", 1.18, 0.99, 1.42,
                      "Study design", "Cohort studies with internal comparison (n=4)", 1.16, 0.86, 1.56,
                      "Study design", "Case-control (n=3)", 1.00, 0.43, 2.35,
                      "Study design", "Industry-based (n=10)", 1.16, 0.99, 1.36,
                      "Study design", "Population-based (n=3)", 1.10, 0.88, 1.38,
                      
                      "Exposure group", "Lowest* (n=5)", 1.11, 1, 1.23,
                      "Exposure group", "Highest* (n=5)", 1.21, 1.07, 1.37,
                      
                      "Study quality", "High (n=4)", 1.20, 0.92, 1.56,
                      "Study quality", "Moderate (n=8)", 1.12, 0.95, 1.32,
                      "Study quality", "Low (n=1)", 0.73, 0.24, 1.71,
                      
                      "Exposure quality", "High (n=4)", 1.26, 1.00, 1.6,
                      "Exposure quality", "Moderate (n=5)", 1.08, 0.91, 1.28,
                      "Exposure quality", "Low (n=4)", 0.94, 0.45, 1.99,

                      "Smoking", "Adjusted (n=4)", 1.13, 0.96, 1.32,
                      "Smoking", "Not adjusted (n=9)", 1.14, 0.95, 1.38,
                      
                      "Continent", "North America (n=5)", 1.15, 0.88, 1.51,
                      "Continent", "Europe (n=3)", 1.18, 1.11, 1.25,
                      "Continent", "Asia (n=5)", 1.04, 0.65, 1.66,
                      
                      "Sex", "Only male (n=7)", 1.04, 0.97, 1.12,
                      "Sex", "Mixed (n=6)", 1.21, 1.09, 1.34,
                      
) %>% 
  as.data.frame() %>% 
  mutate(sub = factor(sub, levels = c(
                                      "Exposure group",
                                      "Study design", 
                                      "Study quality", 
                                      "Exposure quality", 
                                      "Smoking",
                                      "Sex",
                                      "Continent")),
         group = case_when(
           sub == "Study design" ~ factor(group, levels = c("Cohort (n=10)", 
                                                            "Cohort studies with external comparison (n=6)", 
                                                            "Cohort studies with internal comparison (n=4)", 
                                                            "Case-control (n=3)", 
                                                            "Industry-based (n=10)", 
                                                            "Population-based (n=3)")),
           sub == "Exposure group" ~ factor(group, levels = c("Lowest* (n=5)", 
                                                              "Highest* (n=5)")),
           sub == "Study quality" ~ factor(group, levels = c("High (n=4)", 
                                                             "Moderate (n=8)", 
                                                             "Low (n=1)")),
           sub == "Exposure quality" ~ factor(group, levels = c("High (n=4)", 
                                                                "Moderate (n=5)", 
                                                                "Low (n=4)")),
           sub == "Smoking" ~ factor(group, levels = c("Adjusted (n=4)", 
                                                                  "Not adjusted (n=9)")),
           sub == "Continent" ~ factor(group, levels = c("North America (n=5)", 
                                                         "Europe (n=3)", 
                                                         "Asia (n=5)")),
           sub == "Sex" ~ factor(group, levels = c("Only male (n=7)", 
                                                         "Mixed (n=6)"))
         ))
glimpse(sub_result)



pdf(file = "subplot.pdf", width = 15, height = 7)
ggplot(sub_result, aes(x = group, y = rr, color = sub, shape = sub)) +
  geom_point(size = 4.5) +  # Points with distinct shapes
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.3, linewidth = 0.9) +  # Error bars with thicker lines
  scale_color_manual(values = c("#000000", "#CC79A7", "#56B4E9", "#009E73", "#D55E00", "#0072B2", "#F5C710")) +  # Colorblind-friendly palette
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 15)) +  # Assign distinct shapes
  theme_minimal(base_size = 14) +  # Minimal theme with increased base font size for readability
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),  # Rotate and adjust x-axis labels
        axis.title.x = element_blank(),  # Remove x-axis title for cleaner look
        legend.title = element_blank(),  # Remove legend title
        legend.position = "",  # Position legend at the top
        # legend.text = element_text(size = 12),  # Increase legend text size
        panel.grid.minor = element_blank(),
        panel.spacing = unit(1, "lines"),
        axis.title.y = element_text(face = "bold"),
        # axis.text.x.bottom = element_text(size = 15)
        ) +  # Remove minor grid lines
  labs(y = "Pooled RR") + 
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.4, color = "gray1") +  # Emphasize reference line
  facet_wrap(~sub, scales = "free_x", nrow = 1) +  # Facets based on `sub`, with free x-scales and single row layout
  theme(strip.text.x = element_text(size = 14, face = "bold"),
        axis.text.x = element_text(size = 13.4))


```



##3.5 pub bias

```{r}

# Produce funnel plot
meta::funnel(ma_ever,
             # xlim = c(0, 2),
             studlab = T)



### contour-enhanced funnel plots
col.contour = c("gray75", "gray85", "gray95")

# Generate funnel plot (we do not include study labels here)
meta::funnel(ma_ever,
             # xlim = c(-0.5, 2),
             contour = c(0.9, 0.95, 0.99),
             col.contour = col.contour,
             xlab = "RR")

# Add a legend
legend(x = 2, y = 0.02, 
       legend = c("p < 0.1", "p < 0.05", "p < 0.01"), 
       cex = 0.8, 
       fill = col.contour)


```

we then produce egger's test
```{r}


if (!require("remotes")) {
  install.packages("remotes")
}
remotes::install_github("MathiasHarrer/dmetar")

require(dmetar)

eggers.test(ma_ever)


```


#4. ROB score visulisation

```{r}

# construct ROB table based on the table S1 and S2
rob_result <- tribble(
  ~study, ~D1, ~D2, ~D3, ~D4, ~D5, ~D6, 
  "Wong et al. (1987)",         3, 1, 2, 1, 1, 1,
  "Collins et al. (2003)",      1, 2, 2, 0, 2, 1,
  "Sorahan et al. (2005)",      2, 0, 3, 1, 1, 1,
  "Hoshuyama et al. (2006)",    2, 1, 2, 1, 2, 1,
  "Koh et al. (2011)",          2, 0, 3, 1, 0, 1,
  "Koh et al. (2014)",          2, 0, 2, 1, 0, 1,
  "Linet et al. (2015)",        3, 2, 3, 1, 2, 2,
  "Collins et al. (2015)",      1, 2, 2, 1, 2, 1,
  "Babigumira et al. (2023)",   3, 2, 4, 2, 2, 2,
  "DeMoulin et al. (2024)",     3, 1, 4, 2, 2, 2,
  "Greenland et al. (1994)*",   3, 1, 3, 0, 2, 1,
  "McHugh et al. (2010)*",      3, 0, 3, 1, 0, 1,
  "Wan et al. (2024)*",         2, 1, 4, 2, 0, 2
                      ) %>% 
  as.data.frame() %>% 
    mutate(
    D1 = case_when(
      D1 == 3 ~ "low",
      D1 %in% c(2, 1) ~ "some concern",
      D1 == 0 ~ "high"
    ),
    D2 = case_when(
      D2 == 2 ~ "low",
      D2 == 1 ~ "some concern",
      D2 == 0 ~ "high"
    ),
    D3 = case_when(
      D3 %in% c(4, 3) ~ "low",
      D3 == 2 ~ "some concern",
      D3 %in% c(1, 0) ~ "high"
    ),
    D4 = case_when(
      D4 == 2 ~ "low",
      D4 == 1 ~ "some concern",
      D4 == 0 ~ "high"
    ),
    D5 = case_when(
      D5 == 2 ~ "low",
      D5 == 1 ~ "some concern",
      D5 == 0 ~ "high"
    ),
    D6 = case_when(
      D6 == 2 ~ "low",
      D6 == 1 ~ "some concern",
      D6 == 0 ~ "high"
    )
  )

                      
glimpse(rob_result)

# Reshape the data to long format for ggplot
data_long <- rob_result %>%
  pivot_longer(cols = starts_with("D"), names_to = "Domain", values_to = "rob") %>% 
  mutate(Domain = case_when(
    Domain == "D1" ~ "Population inclusion",
    Domain == "D2" ~ "Exposure assessment",
    Domain == "D3" ~ "Outcome assessment",
    Domain == "D4" ~ "Confounding",
    Domain == "D5" ~ "Follow-up / Participation rate*",
    Domain == "D6" ~ "Statistical analysis"
  )) %>% 
  mutate(Domain = factor(Domain, levels = c( "Population inclusion", "Exposure assessment", "Outcome assessment", "Confounding", "Follow-up / Participation rate*", "Statistical analysis"))) %>% 
  mutate(rob = factor(rob, 
                         levels = c("low", "some concern", "high"), 
                         labels = c("Low risk", "Some concern", "High risk"))) %>% 
  mutate(study = factor(study, levels = rev(rob_result$study)))


pdf(file = "ROB_plot.pdf", width = 11, height = 7)
ggplot(data_long, aes(x = Domain, y = study, fill = rob, pattern = rob)) +
  geom_tile_pattern(color = "white", size = 0.2, 
                    pattern_density = 0.01, # Adjust the density of the pattern
                    pattern_fill = "black", # Color of the pattern lines
                    pattern_spacing = 0.05) + # Spacing between pattern lines
  scale_fill_manual(values = c("Low risk" = "#56B4E9", "Some concern" = "#F0E442", "High risk" = "#D55E00"),
                    name = "",
                    guide = "legend") +
  scale_pattern_manual(values = c("Low risk" = "stripe", "Some concern" = "crosshatch", "High risk" = "circle"),
                       name = "",
                       guide = "legend") +
  theme_minimal() +
  labs(
       x = "",
       y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.text.x.bottom  = element_text(face = "bold", size = 11),
        axis.text.y.left = element_text(size = 11),
        legend.text = element_text(size = 9))
dev.off()


```














##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################


legancy chunks below, DO NOT RUN. 


##########################################################################


using one knot and test the res curve shows no difference
```{r}

knots_new <- quantile(dat_metareg$exp,  0.5)
require(splines)
fit <- dosresmeta(formula = logrr ~ ns(exp, knots = knots_new), 
                  se = se,
                  id = study, 
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "reml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg, intercept = F, proc = "1stage",
                  )
summary(fit)

fit_lin_1st <- dosresmeta(formula = logrr ~ exp,
                  se = se,
                  id = study,
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "reml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg,intercept = F, proc = "1stage",
                  )
summary(fit_lin_1st)


pred_val <- predict(fit, newdata = newdata, expo = T) # transform back to original RR scale
require(ggsci)
newdata <- data.frame(exp <- seq(0, 10.2, 0.01)) 
colnames(newdata)[1] <- "exp"

pred_val <- cbind(newdata, pred_val)

# Plot the data with error bars, log-linear fit, and SE
ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_val, aes(x = exp, y = pred), color = "blue") +
  geom_ribbon(data = pred_val, aes(x = exp, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +
    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()



# for linear fit
pred_val_lin <- predict(fit_lin_1st, newdata = newdata, expo = T) # transform back to original RR scale

ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_val_lin, aes(x = exp, y = pred), color = "blue") +
  geom_ribbon(data = pred_val_lin, aes(x = exp, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +
    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()



```


