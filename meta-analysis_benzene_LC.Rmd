---
title: "meta-analysis benzene-LC studies"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

##################### 

**Any question? email w.wan@uu.nl or charleswanwen@gmail.com**

#####################


This script follows the systematic search of papers on the effect of occupational benzene exposure on lung cancer up till 2024, and stands for the formal meta-analysis (MA) of the risk estimates extracted from these studies. Details for the data extracted and the screening process are recorded in the associated paper. The main structure of the following codes follows:


1. for studies only reported exposure within several exposure categories without reporting ever-exposure effect, collapse risk estimates with fixed-effect MA
2. ever exposure MA [main analysis, fig 2]
3. do various sensitivity analyses:
  3.1 Meta-regression over three studies that reported original benzene exposure scales (with ref to https://ehp.niehs.nih.gov/doi/10.1289/ehp.1306880)
  3.2 break-up pooled studies from Wan et al. (2024) and include these as individual studies to be included with other studies for MA on ever-exposure
  3.3 do various subgroup analyses 
    3.3.1 effect sizes from highest vs. lowest exposure category used
    3.3.2 overall quality (low, moderate, high)
    3.3.3 exposure assessment quality (low, medium, high)
    3.3.4 whether smoking was adjusted
    3.3.5 stratify by continent
  3.4 combine all results from 3.3 to produce one figure (fig 3)  
  3.5 pub bias
4. ROB assessment scores (visualisation of)  

```{r load packages, include=FALSE}

require(dplyr)
require(tidyverse)
require(meta)
require(ggplot2)
require(readxl)
require(glmnet)
require(ggforce)
require(dosresmeta)
require(dosresmeta)
require(rms)
require(ggforce)
require(ggsci)
require(robvis)
library(tibble)
library(tidyr)
library(ggpattern)
require(ggsci)

```



#1. calculate the ever-exposure estimates from studies with multiple exposure categories group that did not report

For the following studies:

- Babigumira et al. (2023)
- Collins et al. (2003)
- Mattei et al. (2016)

please note for Koh et al. (2011)_///note: not to be pooled, estimates of all workers will be used instead.


```{r}

# record data

mult_grp_dat <- tribble(~study_label, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type, ~study, ~comp_grp,
               "Babigumira_q1", 1.51, 0.93, 2.47, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal", 
               "Babigumira_q2", 1.47, 0.86, 2.52, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal",
               "Babigumira_q3", 1.20, 0.66, 2.19, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal",
               "Babigumira_q4", 1.27, 0.69, 2.35, -9999, "cohort", "industry-based", "Babigumira et al. (2023)", "internal",
###

### new revised results from Norway study (dec OEM submission)
               "Babigumira_q1", 1.47, 0.90, 2.40, -9999, "cohort", "industry-based", "Babigumira et al. (2023)_v2", "internal", 
               "Babigumira_q2", 1.30, 0.75, 2.26, -9999, "cohort", "industry-based", "Babigumira et al. (2023)_v2", "internal",
               "Babigumira_q3", 1.18, 0.64, 2.15, -9999, "cohort", "industry-based", "Babigumira et al. (2023)_v2", "internal",
               "Babigumira_q4", 1.15, 0.61, 2.16, -9999, "cohort", "industry-based", "Babigumira et al. (2023)_v2", "internal",
###
               "Collins_<1", 1.1, 0.7, 1.5, 32, "cohort", "industry-based", "Collins et al. (2003)", "external",
               "Collins_>1-6", 1.3, 1.0, 1.8, 39, "cohort", "industry-based", "Collins et al. (2003)", "external",
               "Collins_>6", 1.6, 1.2, 2.1, 55, "cohort", "industry-based", "Collins et al. (2003)", "external",
###
               # "Mattei_low", 1.01, 0.59, 1.71, 108, "case-control", "population-based", "Mattei et al. (2016)",  "internal",
               # "Mattei_medium", 0.86, 0.45, 1.65, 106, "case-control", "population-based", "Mattei et al. (2016)",  "internal",
               # "Mattei_high", 0.95, 0.44, 2.04, 129, "case-control", "population-based", "Mattei et al. (2016)",  "internal",
###
               "Wan_<1", 1.12, 1.03, 1.21, 2190, "case-control", "population-based", "Wan et al. (2023)", "internal",
               "Wan_1-5", 1.17, 1.08, 1.27, 2553, "case-control", "population-based", "Wan et al. (2023)", "internal",
               "Wan_>5", 1.32, 1.18, 1.48, 1095, "case-control", "population-based", "Wan et al. (2023)", "internal",
)

ma_collap <- metagen(data = mult_grp_dat,
                   TE = log(mult_grp_dat$rr),
                   studlab = study_label,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(mult_grp_dat$lower_ci),
                   upper = log(mult_grp_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = study
                   )

# require(grid)

forest(ma_collap, xlim = c(0.5,3), pooled.totals = F,  layout = "RevMan5", random = T, common = T, subgroup = T, overall = F, prediction = T, prediction.subgroup = T, study.results = F)
# grid.text("Meta-analysis of ever-benzene exposure on lung cancer risk for all studies included in the IARC Monograph on Benzene, stratified by population types", .5, 0.96, gp=gpar(cex=1.2))



```


#2. ever exposure MA [main analysis, fig 2]


```{r}

dat_ever <- tribble(~study, ~year, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,  ~comp_grp, ~study_type, ~study_quality, ~exposure_quality, ~region, ~sex, ~smoking,
               "Wong et al. (1987)", 1987, 1.29, 1.00, 1.65, 18, "Cohort", "Industry-based", "external", "Cohort studies with external comparison",  "Moderate",  "Medium", "USA", "only male", "not adjusted",
               # for collins (2003), the sum o/e is calculated (252/191.8) to obtain ever_exp estimates
               "Collins et al. (2003)", 2003, 1.31, 1.16, 1.48, 252, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "High", "USA", "mixed", "not adjusted",
               "Sorahan et al. (2005)", 2005, 1.19, 1.06, 1.34, 293, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "low", "Europe", "mixed", "not adjusted",
               "Hoshuyama et al. (2006)",2006, 1.04, 1.00, 1.08, 11, "Cohort", "Industry-based", "internal", "Cohort studies with internal comparison", "Moderate", "Medium", "Asia", "only male", "not adjusted",
               "Koh et al. (2011)", 2011, 0.35, 0.11, 0.83, 6, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "Low", "Asia", "only male", "not adjusted",
               "Koh et al. (2014)", 2014, 0.73, 0.24, 1.71, 5, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Low", "Low", "Asia", "only male","not adjusted",
               "Linet et al. (2015)",2015, 1.5, 1.2, 1.9, 351, "Cohort", "Industry-based", "internal", "Cohort studies with internal comparison", "High", "High", "Asia", "mixed","not adjusted",
               "Collins et al. (2015)", 2015, 1.05, 0.89, 1.24, 146, "Cohort", "Industry-based", "external", "Cohort studies with external comparison", "Moderate", "High", "USA", "mixed","not adjusted",
               # for Babigumira 2023, fixed-effect MA for three exp categories was used to estimate the ever_exp est.
               "Babigumira et al. (2023)",2023, 1.29, 0.98, 1.71, 292, "Cohort", "Industry-based", "internal", "Cohort studies with internal comparison", "High", "High", "Europe", "only male","adjusted",
               "Wan et al. (2024)", 2024, 1.17, 1.10, 1.24, 5838, "Case-control", "population-based", "internal",  "Case-control", "high", "medium", "Europe", "mixed","adjusted",
               # for mattei 2016, fixed-effect MA for three exp categories was used to estimate the ever_exp est.
               # "Mattei et al. (2016)", 0.95, 0.66, 1.36, 343, "case-control", "population-based", "internal", "case-control", "high", "low", "Europe", "mixed","adjusted",
               "McHugh et al. (2010)", 2010, 1.13, 0.69, 1.86, 38, "Case-control", "population-based", "internal","Case-control", "Moderate", "low", "USA", "mixed","adjusted",
               "Greenland et al. (1994)",1994, 0.58, 0.31, 1.07, -99999, "Case-control", "Industry-based", "internal", "Case-control", "Moderate", "medium", "USA", "only male","not adjusted",
               ## excluded wong study 
               # "Wong et al (1993)_land", 0.66, 0.57, 0.77, 165, "cohort", "industry-based", "external", "cohort study with external comparison", "x", "x", "x", "men", "not adjusted",
               # "Wong et al (1993)_marine", 1.07, 0.94, 1.21, 208, "cohort", "industry-based", "external", "cohort study with external comparison", "x", "x", "x", "men", "not adjusted",
               # "Wong et al (1993)_calculated_combined", 0.8394, 0.7574, 0.9279, 373, "cohort", "industry-based", "external", "cohort study with external comparison", "x", "x", "x", "men", "not adjusted",
               ) %>% 
    mutate(across(7:15, ~ str_replace(., "^.", toupper)))

dat_ever$study_quality <- factor(dat_ever$study_quality,
                                 levels = c("High", "Moderate", "Low"))

dat_ever$exposure_quality <- factor(dat_ever$exposure_quality,
                                 levels = c("High", "Medium", "Low"))


order_dat <- dat_ever[order(dat_ever$year),]

ma_ever <- metagen(data = order_dat,
                   TE = log(order_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(order_dat$lower_ci),
                   upper = log(order_dat$upper_ci),
                   hakn = TRUE
                   # subgroup = study_type #vary this so various stratification can be made
                   )
# ma_ever$studlab <- "Study"

forest(ma_ever,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       leftcols = c("studlab", "seTE"),
       just = "left")


summary(ma_ever)


```


#3. do various sensitivity analyses:

##3.1 Meta-regression over studies that reported original benzene exposure scales

mid-point was used to except for the highest exp category, where 5/3 * lower bound will be used.

```{r}

dat_metareg <- tribble(~study, ~exp, ~RR, ~lower_ci, ~upper_ci, ~case, ~N, ~type,
                       "Babigumira et al. (2023)", 0, 1, NA, NA,  112, 767, "ci",
                       "Babigumira et al. (2023)", 0.008, 1.47, 0.90, 2.40,  85, 417, "ci",
                       "Babigumira et al. (2023)", 0.042, 1.30, 0.75, 2.26,  72, 417, "ci",
                       "Babigumira et al. (2023)", 0.120, 1.18, 0.64, 2.15, 63, 417, "ci",
                       "Babigumira et al. (2023)", 0.285, 1.15, 0.61, 2.16, 67, 416, "ci",
                       "Collins et al. (2003)", 0, 1.3, 1.1, 1.5, 126, 224.5, "ci",
                       "Collins et al. (2003)", 0.5, 1.1, 0.70, 1.50, 32, 62, "ci",
                       "Collins et al. (2003)", 3.5, 1.3, 1.00, 1.80, 39, 68, "ci",
                       "Collins et al. (2003)", 10, 1.6, 1.20, 2.10, 55, 89.3, "ci",
                       "Wan et al. (2024)", 0, 1, NA, NA, 6491,  15957, "cc", 
                       "Wan et al. (2024)", 0.5, 1.12, 1.03, 1.21, 2190, 4739, "cc",
                       "Wan et al. (2024)", 3, 1.17,  1.08, 1.27, 2553, 5251, "cc",
                       "Wan et al. (2024)", 8.3, 1.32, 1.18, 1.48, 1095, 2101, "cc"
) %>% 
  mutate(logrr = log(RR)) %>% 
  mutate(se = log(upper_ci) - log(lower_ci) / (2 * 1.96)) %>% 
  mutate(se = if_else(exp == 0, NA, se)) # this makes the control group se == 0, for the calculation of cov matrix

head(dat_metareg)


#obtain log-linear function

knots <- quantile(dat_metareg$exp, c(0.2, 0.5, 0.8))

fit <- dosresmeta(formula = logrr ~ rcs(exp, knots), 
                  se = se,
                  id = study, 
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "reml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg
                  )

fit_lin <- dosresmeta(formula = logrr ~ exp,
                  se = se,
                  id = study,
                  type = type,
                  cases = case,
                  n = N,
                  covariance = "gl", # specify the use of Greenland and Longnecker method
                  method = "reml", #  random-effects models fitted through (restricted) maximum likelihood
                  data = dat_metareg,
                  )

# summary(fit)
# 
newdata <- data.frame(exp <- seq(0, 10.2, 0.01))
# 
# newdata$study = "Babigumira et al. (2023)"



pred_val <- predict(fit, newdata = newdata, expo = T) # transform back to original RR scale
require(ggsci)

# Plot the data with error bars, log-linear fit, and SE
ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_val, aes(x = `rcs(exp, knots)exp`, y = pred), color = "blue") +
  geom_ribbon(data = pred_val, aes(x = `rcs(exp, knots)exp`, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +
    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()



# for linear fit
pred_val_lin <- predict(fit_lin, newdata = newdata, expo = T) # transform back to original RR scale

ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_val_lin, aes(x = exp, y = pred), color = "blue") +
  geom_ribbon(data = pred_val_lin, aes(x = exp, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +
    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()

summary(fit)
summary(fit_lin)

```

##3.2 break-up pooled studies from Wan et al. (2024) and include these as individual studies to be included with other studies for MA on ever-exposure

```{r}

dat_incl_syn <- dat_ever %>% 
  select(study, rr, lower_ci, upper_ci) %>% 
  rbind(tribble(~study, ~rr, ~lower_ci, ~upper_ci,
                "AUT", 1.28, 1.08, 1.51,
                "EAGLE", 0.98, 0.82, 1.18,
                "HdA", 1.33, 0.97, 1.83,
                "ICARE", 1.2, 1.04, 1.38,
                "INCO_UK", 1.04, 0.73, 1.49,
                "LUCAS", 1.07, 0.82, 1.4,
                "Montreal", 0.98, 0.78, 1.24,
                "Morgen", 3.59,  1.22, 10.58,
                "Turin/Veneto", 1.13, 0.84, 1.54,
                "Capua", 1.31, 0.9, 1.9,
                "INCO_CR", 1.24, 0.83, 1.87,
                "INCO_HU", 1.07, 0.72, 1.6,
                "INCO_PO", 0.93, 0.71, 1.21,
                "INCO_RO", 2.14, 1.21, 3.8,
                "INCO_RU", 1.06, 0.79, 1.44,
                "INCO_SL", 1.28, 0.83, 1.98,
                "LUCA", 0.91, 0.51, 1.62,
                "Paris", 0.99, 0.37, 2.63,
                "Rome", 1.25, 0.73, 2.14,
                "Toronto", 1.51, 1.04, 2.18,
                )) %>% 
  filter(!study == "Wan et al. (2024)")

dat_incl_syn$study[12:31] <- paste0("SYNERGY-", dat_incl_syn$study[12:31])



ma_ever_incl.syn <- metagen(data = dat_incl_syn,
                   TE = log(dat_incl_syn$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_incl_syn$lower_ci),
                   upper = log(dat_incl_syn$upper_ci),
                   hakn = TRUE
                   )

forest(ma_ever_incl.syn,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       leftcols = c("studlab", "seTE"),
       just = "left")



```



##3.3 do various subgroup analyses 

  3.3 do various subgroup analyses 
    3.3.0 study design (external, internal, cohort, case-control)
    3.3.1 effect sizes from highest vs. lowest exposure category used
    3.3.2 overall quality (low, moderate, high)
    3.3.3 exposure assessment quality (low, medium, high)
    3.3.4 whether smoking was adjusted
    3.3.5 stratify by continent
  3.4 combine all results from 3.3 to produce one figure (fig 3)  
  3.5 pub bias


###3.3.0 study design (external, internal, cohort, case-control)

```{r design}


order_dat <- dat_ever[order(dat_ever$year),] %>% 
  mutate(study_type = factor(order_dat$study_type,
                             levels = c("Cohort studies with external comparison", "Cohort studies with internal comparison", "Case-control" )))

ma_ever_2 <- metagen(data = order_dat,
                   TE = log(order_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(order_dat$lower_ci),
                   upper = log(order_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = study_type #vary this so various stratification can be made
                   )
# ma_ever$studlab <- "Study"

forest(ma_ever_2,
       xlim = c(0.5,2.5), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       subgroup.name = "",
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")


summary(ma_ever_2)


```



```{r by design cohort vs cc}


order_dat <- dat_ever[order(dat_ever$year),] %>% 
  mutate(study_type = factor(order_dat$study_type,
                             levels = c("Cohort studies with external comparison", "Cohort studies with internal comparison", "Case-control" )))

ma_ever_2 <- metagen(data = order_dat,
                   TE = log(order_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(order_dat$lower_ci),
                   upper = log(order_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = design #vary this so various stratification can be made
                   )
# ma_ever$studlab <- "Study"

forest(ma_ever_2,
       xlim = c(0.5,2.5), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       subgroup.name = "",
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")


summary(ma_ever_2)


```

###3.3.1 Effect sizes from highest vs. lowest exposure category used

```{r low exposure}

# 
dat_low <- tribble(~study, ~year, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
               "Wong et al. (1987): sporadic exposure", 1987, 1.46, 0.86, 2.3, 18, "cohort", "industry-based",
               "Collins et al. (2003): low exposure", 2003, 1.1, 0.7, 1.5, 32, "cohort", "industry-based",
               "Sorahan et al. (2005)", 2005, 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
               "Hoshuyama et al. (2006)",2006, 1.04, 1.00, 1.08, 11, "cohort", "industry-based",
               "Koh et al. (2011)", 2011, 0.35, 0.11, 0.83, 6, "cohort", "industry-based",
               "Koh et al. (2014)", 2014, 0.73, 0.24, 1.71, 5, "cohort", "industry-based",
               "Linet et al. (2015)", 2015, 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
               "Collins et al. (2015)", 2015, 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
               "Babigumira et al. (2023): low exposure",2023,  1.47, 0.9, 2.4, -9999, "cohort", "industry-based",
               "Wan et al. (2024): low exposure",2024, 1.12, 1.03, 1.21, 12329, "case-control", "population-based",
               # "Mattei et al. (2016)_low", 1.01, 0.59, 1.71, 129, "case-control", "population-based",
               "McHugh et al. (2010)",2010,  1.13, 0.69, 1.86, 38, "case-control", "population-based",
               "Greenland et al. (1994)", 1994, 0.58, 0.31, 1.07, -99999, "case-control", "industry-based")

dat_low <- dat_low[order(dat_low$year),]

#
meta_dat1 <- metagen(data = dat_low,
                   TE = log(dat_low$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_low$lower_ci),
                   upper = log(dat_low$upper_ci),
                   hakn = TRUE
                   )

forest(meta_dat1,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")


```


```{r high exposure}

dat_high <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
               "Wong et al. (1987)", 1.25, 0.91, 1.66, 65, "cohort", "industry-based",
               "Collins et al. (2003): high exposure group", 1.6, 1.2, 2.1, 55, "cohort", "industry-based",
               "Sorahan et al. (2005)", 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
               "Hoshuyama et al. (2006)", 1.04, 1.00, 1.08, 11, "cohort", "industry-based",
               "Koh et al. (2011): high exposure group", 1.42, 0.52, 3.09, 6, "cohort", "industry-based",
               "Koh et al. (2014)", 0.73, 0.24, 1.71, 5, "cohort", "industry-based",
               "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
               "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
               "Babigumira et al. (2023): high exposure group", 1.15, 0.61, 2.16, -9999, "cohort", "industry-based",
               "Wan et al. (2024): high exposure group", 1.32, 1.18, 1.48, 12329, "case-control", "population-based",
               # "Mattei et al. (2016)", 0.95, 0.44, 2.04, 129, "case-control", "population-based",
               "McHugh et al. (2010)", 1.13, 0.69, 1.86, 38, "case-control", "population-based",
               "Greenland et al. (1994)", 0.58, 0.31, 1.07, -99999, "case-control", "industry-based") %>% 
  as.data.frame() %>% 
  cbind(dat_ever$year) %>% 
  rename(year = colnames(dat_high)[8])

dat_high <- dat_high[order(dat_high$year),]

meta_dat2 <- metagen(data = dat_high,
                   TE = log(dat_high$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_high$lower_ci),
                   upper = log(dat_high$upper_ci),
                   hakn = TRUE
                   )

forest(meta_dat2,
       xlim = c(0.8,2), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       col.subgroup = "black",
       leftcols = c("studlab", "TE","seTE"),
       just = "left")

```


###3.3.2-5 subgroup (batch producing)
    3.3.2 overall quality (low, moderate, high)
    3.3.3 exposure assessment quality (low, medium, high)
    3.3.4 whether smoking was adjusted
    3.3.5 stratify by continent

```{r}

glimpse(dat_ever)

subgroup <- c("type", "study_quality", "exposure_quality", "sex", "smoking", "region")

dat_ever$region <- ifelse(dat_ever$region == "USA", "North America", dat_ever$region)
dat_ever$exposure_quality <- ifelse(dat_ever$exposure_quality == "Medium", "Moderate", dat_ever$exposure_quality)
dat_ever$exposure_quality <- factor(dat_ever$exposure_quality,
                                 levels = c("High", "Moderate", "Low"))


for (i in subgroup) {
  
ma_ever_sub <- metagen(data = dat_ever,
                   TE = log(dat_ever$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_ever$lower_ci),
                   upper = log(dat_ever$upper_ci),
                   hakn = TRUE,
                   subgroup = eval(parse(text = paste0(i))) 
                   )
# ma_ever$studlab <- "Study"
 file_name <- paste0("forest_plot_", i, ".png")
  
  # Open the PNG device
  png(file_name, width = 900, height = 600)
  
forest(ma_ever_sub,
       xlim = c(0.5,2.5), 
       pooled.totals = T,  
       # layout = "BMJ",
       random = T,
       weight.study = "random", 
       common = F, 
       # subgroup = F,     
       # col.subgroup = "black", # Set subgroup label color to black
       # font.subgroup = 2, # Set font style to bold for subgroup labels
       cex = 1.2, # Increase text size for readability
       col.diamond = "blue", # Use high contrast color
       col.square = "darkgreen", 
       col.inside = "black", 
       col.study = "black",
       col.label = "black",
       text.random = "Overall", 
       fs.hetstat = 9, 
       digits.se = 2, 
       digits.TE = 2,
       subgroup.name = "",
       col.subgroup = "black",
       # leftcols = c("studlab", "TE","seTE"),
       just = "left")

dev.off()
}



```


  3.4 combine all results from 3.3 to produce one figure (fig 3)  
  3.5 pub bias

##3.4 combine subgroup results

```{r}

sub_result <- tribble(~sub, ~group, ~rr, ~lower_ci, ~upper_ci,
                      "Study design", "Cohort", 1.18, 1.02, 1.36,
                      "Study design", "Cohort studies with external comparison", 1.18, 0.99, 1.42,
                      "Study design", "Cohort studies with internal comparison", 1.23, 0.76, 1.99,
                      "Study design", "Case-control", 1.00, 0.43, 2.35,
                      "Study design", "Industry-based", 1.16, 0.99, 1.36,
                      "Study design", "Population-based", 1.17, 1.11, 1.23,
                      
                      "Exposure Level", "Low exposure group", 1.12, 1, 1.26,
                      "Exposure Level", "High exposure group", 1.19, 1.05, 1.36,
                      
                      "Study quality", "High", 1.27, 0.93, 1.75,
                      "Study quality", "Moderate", 1.12, 0.95, 1.32,
                      "Study quality", "Low", 0.73, 0.24, 1.71,
                      
                      "Exposure quality", "High", 1.26, 1, 1.6,
                      "Exposure quality", "Moderate", 1.1, 0.86, 1.42,
                      "Exposure quality", "Low", 0.94, 0.45, 1.99,

                      "Smoking adjustment", "Adjusted", 1.17, 1.1, 1.25,
                      "Smoking adjustment", "Not adjusted", 1.14, 0.95, 1.38,
                      
                      "Continent", "North America", 1.15, 0.88, 1.51,
                      "Continent", "Europe", 1.18, 1.11, 1.25,
                      "Continent", "Asia", 0.94, 0.39, 2.3,
) %>% 
  as.data.frame() %>% 
  mutate(sub = factor(sub, levels = c(
                                      "Exposure Level",
                                      "Study design", 
                                      "Study quality", 
                                      "Exposure quality", 
                                      "Smoking adjustment", 
                                      "Continent")),
         group = case_when(
           sub == "Study design" ~ factor(group, levels = c("Cohort", 
                                                            "Cohort studies with external comparison", 
                                                            "Cohort studies with internal comparison", 
                                                            "Case-control", 
                                                            "Industry-based", 
                                                            "Population-based")),
           sub == "Exposure Level" ~ factor(group, levels = c("Low exposure group", 
                                                              "High exposure group")),
           sub == "Study quality" ~ factor(group, levels = c("High", 
                                                             "Moderate", 
                                                             "Low")),
           sub == "Exposure quality" ~ factor(group, levels = c("High", 
                                                                "Moderate", 
                                                                "Low")),
           sub == "Smoking adjustment" ~ factor(group, levels = c("Adjusted", 
                                                                  "Not adjusted")),
           sub == "Continent" ~ factor(group, levels = c("North America", 
                                                         "Europe", 
                                                         "Asia"))
         ))
glimpse(sub_result)




ggplot(sub_result, aes(x = group, y = rr, color = sub, shape = sub)) +
  geom_point(size = 4.5) +  # Points with distinct shapes
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.3, linewidth = 0.9) +  # Error bars with thicker lines
  scale_color_manual(values = c("#000000", "#CC79A7", "#56B4E9", "#009E73", "#D55E00", "#0072B2")) +  # Colorblind-friendly palette
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20)) +  # Assign distinct shapes
  theme_minimal(base_size = 14) +  # Minimal theme with increased base font size for readability
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),  # Rotate and adjust x-axis labels
        axis.title.x = element_blank(),  # Remove x-axis title for cleaner look
        legend.title = element_blank(),  # Remove legend title
        legend.position = "",  # Position legend at the top
        # legend.text = element_text(size = 12),  # Increase legend text size
        panel.grid.minor = element_blank(),
        panel.spacing = unit(1, "lines"),
        axis.title.y = element_text(face = "bold"),
        # axis.text.x.bottom = element_text(size = 15)
        ) +  # Remove minor grid lines
  labs(y = "Pooled RR") + 
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.4, color = "gray1") +  # Emphasize reference line
  facet_wrap(~sub, scales = "free_x", nrow = 1) +  # Facets based on `sub`, with free x-scales and single row layout
  theme(strip.text.x = element_text(size = 13, face = "bold"),
        axis.text.x = element_text(size = 12))

```



##3.5 pub bias

```{r}

# Produce funnel plot
meta::funnel(ma_ever,
             # xlim = c(0, 2),
             studlab = T)



### contour-enhanced funnel plots
col.contour = c("gray75", "gray85", "gray95")

# Generate funnel plot (we do not include study labels here)
meta::funnel(ma_ever,
             # xlim = c(-0.5, 2),
             contour = c(0.9, 0.95, 0.99),
             col.contour = col.contour,
             xlab = "RR")

# Add a legend
legend(x = 1.2, y = 0.01, 
       legend = c("p < 0.1", "p < 0.05", "p < 0.01"), cex = 10, 
       fill = col.contour)


```







#4. ROB score visulisation

```{r}

# construct ROB table based on the table S1 and S2
rob_result <- tribble(
  ~study, ~D1, ~D2, ~D3, ~D4, ~D5, ~D6, 
  "Wong et al. (1987)",         3, 1, 2, 1, 1, 1,
  "Collins et al. (2003)",      1, 2, 2, 0, 2, 1,
  "Sorahan et al. (2005)",      2, 0, 3, 1, 1, 1,
  "Hoshuyama et al. (2006)",    2, 1, 2, 1, 2, 1,
  "Koh et al. (2011)",          2, 0, 3, 1, 0, 1,
  "Koh et al. (2014)",          2, 0, 2, 1, 0, 1,
  "Linet et al. (2015)",        3, 2, 3, 1, 2, 2,
  "Collins et al. (2015)",      1, 2, 2, 1, 2, 1,
  "Babigumira et al. (2023)",   3, 2, 4, 2, 2, 2,
  "Greenland et al. (1994)*",   3, 1, 3, 0, 2, 1,
  "McHugh et al. (2010)*",      3, 0, 3, 1, 0, 1,
  "Wan et al. (2024)*",         2, 1, 4, 2, 0, 2
                      ) %>% 
  as.data.frame() %>% 
    mutate(
    D1 = case_when(
      D1 == 3 ~ "low",
      D1 %in% c(2, 1) ~ "some concern",
      D1 == 0 ~ "high"
    ),
    D2 = case_when(
      D2 == 2 ~ "low",
      D2 == 1 ~ "some concern",
      D2 == 0 ~ "high"
    ),
    D3 = case_when(
      D3 %in% c(4, 3) ~ "low",
      D3 == 2 ~ "some concern",
      D3 %in% c(1, 0) ~ "high"
    ),
    D4 = case_when(
      D4 == 2 ~ "low",
      D4 == 1 ~ "some concern",
      D4 == 0 ~ "high"
    ),
    D5 = case_when(
      D5 == 2 ~ "low",
      D5 == 1 ~ "some concern",
      D5 == 0 ~ "high"
    ),
    D6 = case_when(
      D6 == 2 ~ "low",
      D6 == 1 ~ "some concern",
      D6 == 0 ~ "high"
    )
  )

                      
glimpse(rob_result)

# Reshape the data to long format for ggplot
data_long <- rob_result %>%
  pivot_longer(cols = starts_with("D"), names_to = "Domain", values_to = "rob") %>% 
  mutate(Domain = case_when(
    Domain == "D1" ~ "Population inclusion",
    Domain == "D2" ~ "Exposure assessment",
    Domain == "D3" ~ "Outcome assessment",
    Domain == "D4" ~ "Confounding",
    Domain == "D5" ~ "Follow-up / Participation rate*",
    Domain == "D6" ~ "Statistical analysis"
  )) %>% 
  mutate(Domain = factor(Domain, levels = c( "Population inclusion", "Exposure assessment", "Outcome assessment", "Confounding", "Follow-up / Participation rate*", "Statistical analysis"))) %>% 
  mutate(rob = factor(rob, 
                         levels = c("low", "some concern", "high"), 
                         labels = c("Low risk", "Some concern", "High risk"))) %>% 
  mutate(study = factor(study, levels = rev(rob_result$study)))


# png(filename = "ROB_plot.png", width = 800, height = 500)
ggplot(data_long, aes(x = Domain, y = study, fill = rob, pattern = rob)) +
  geom_tile_pattern(color = "white", size = 0.2, 
                    pattern_density = 0.01, # Adjust the density of the pattern
                    pattern_fill = "black", # Color of the pattern lines
                    pattern_spacing = 0.05) + # Spacing between pattern lines
  scale_fill_manual(values = c("Low risk" = "#56B4E9", "Some concern" = "#F0E442", "High risk" = "#D55E00"),
                    name = "",
                    guide = "legend") +
  scale_pattern_manual(values = c("Low risk" = "stripe", "Some concern" = "crosshatch", "High risk" = "circle"),
                       name = "",
                       guide = "legend") +
  theme_minimal() +
  labs(
       x = "",
       y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.x.bottom  = element_text(face = "bold", size = 11),
        axis.text.y.left = element_text(size = 11),
        legend.text = element_text(size = 9))
# dev.off()


```














##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################
##########################################################################


legancy chunks below, DO NOT RUN. 


##########################################################################





```{r}

# with alternative table
metagen2 <- metagen(data = dat,
                   TE = log(dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = T, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat$lower_ci),
                   upper = log(dat$upper_ci),
                   hakn = TRUE,
                   subgroup = type
                   )

# require(grid)

forest(metagen2, xlim = c(0.5,3), pooled.totals = F,  layout = "RevMan5", random = T, weight.study = "random", common = F, subgroup = T)
# grid.text("Meta-analysis of ever-benzene exposure on lung cancer risk for all studies included in the IARC Monograph on Benzene, stratified by population types", .5, 0.96, gp=gpar(cex=1.2))


```






```{r}
# restricting to AML-positive cohort
dat <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
               # "Wong et al. (1987)_all_exp", 1.29, 1.00, 1.65, 18, "cohort", "industry-based",
               "Collins et al. (2003)", 1.36, 1.14, 1.63, 32, "cohort", "industry-based",
               "Sorahan et al. (2005)_incidence", 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
               # "Hoshuyama et al. (2006)", 1.04, 1.00, 1.08, 11, "cohort", "industry-based",
               # "Koh et al. (2011)_all", 0.35, 0.11, 0.83, 6, "cohort", "industry-based",
               # "Koh et al. (2014)_incidence", 0.73, 0.24, 1.71, 5, "cohort", "industry-based",
               "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
               # "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
               "Babigumira et al. (2023)", 1.38, 1.05, 1.82, -9999, "cohort", "industry-based",
               # "Wan et al. (2023)_all_exp", 1.17, 1.10, 1.24, 12329, "case-control", "population-based",
               # "Mattei et al. (2016)_low", 1.01, 0.59, 1.71, 129, "case-control", "population-based",
               # "McHugh et al. (2010)", 1.13, 0.69, 1.86, 38, "case-control", "population-based",
               # "Greenland et al. (1994)", 0.58, 0.31, 1.07, -99999, "case-control", "industry-based")
)


```


```{r}

# with alternative table
metagen2 <- metagen(data = dat,
                   TE = log(dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = T, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat$lower_ci),
                   upper = log(dat$upper_ci),
                   hakn = TRUE,
                   subgroup = design
                   )

# require(grid)

forest(metagen2, xlim = c(0.5,3), pooled.totals = F,  layout = "RevMan5", random = T, weight.study = "random", common = F, subgroup = T)
# grid.text("Meta-analysis of ever-benzene exposure on lung cancer risk for all studies included in the IARC Monograph on Benzene, stratified by population types", .5, 0.96, gp=gpar(cex=1.2))


```






```{r}

alternative_dat2 <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
                           "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
                           "Collins et al. (2003)_median", 1.3, 1.0, 1.8, 162, "cohort", "industry-based",
                           "Sorahan et al. (2005)", 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
                           "Wong et al. (1987)", 1.12, 0.9, 1.39, 86, "cohort", "industry-based",
                           # "Wong et al. (1993)_land_gaso", 0.66, 0.57, 0.77, 165, "cohort", "industry-based", # excluded b/c same study
                           "Wong et al. (1993)_marine_gaso", 1.07, 0.94, 1.21, 208, "cohort", "industry-based",
                           "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
                           "Koh et al. (2011)", 0.22, 0.03, 0.78, 5, "cohort", "industry-based",
                           ##### following general population-based cohorts
                           "Bove et al. (2014)_Lejeune", 0.92, 0.8, 1.04, 237, "cohort", "population-based",
                           "Gérin et al. (1998)", 1.2, 0.7, 1.9, 27, "case-control", "population-based",
                           "Villeneuve et al. (2014)", 1.84, 1.26, 2.68, 445, "case-control", "population-based",
                           "Yuan et al. (2014)", 1.10, 0.44, 2.78, 19, "case-control", "population-based",
                           ##### new evidence after the monograph
                           "Warden et al. (2017)", 1.35, 0.99, 1.84, 652, "case-control", "population-based",
                           "Cheng et al. (2022)", 1.17, 1.02, 1.34, 2796, "case-control", "population-based",
                           # "Babigumira et al. (2023)_confer.abs", 1.47, 0.88, 2.23, 399, "cohort", "industry-based",
                           ##### possible environmental studies
                           #"Winters et al. (2014)_self-report", 1.24, 0.84, 1.79, 38, "case-control", "population-based",
                           #### add our synergy study,
                           "Wan et al. (2023)", 1.17, 1.1, 1.24, 12329, "case-control", "population-based",
                           #### studies outside of IARC Monograph
                           "Bertazzi et al. (1989)_refinery_SMR_approx.", 1.22, 0.82, 1.75, 29, "cohort" , "industry-based",
                           "Bond et al. (1986)", 0.99, 0.59, 1.57, 18, "cohort", "industry-based",
                           "Rushton et al. (1993)_refinery_SMR_approx.", 1.15, 1.01, 1.3, 254, "cohort", "industry-based",
                           "Consonni et al. (1999)_refinery_SMR_approx.", 1.07, 0.79, 1.43, 46, "cohort", "industry-based", 
                           # "Ferreccio et al. (2013)", 8.7, 0.63, 120, 2, "case-control", "population-based", ### Arsenic-focused, NA for benzene
                           "Gun et al. (2006)_SIR", 0.69, 0.57, 0.83, 113, "cohort", "industry-based",
                           # "Hayes et al. (1996)_no CIs present", 1.4, 1.4, 1.4, "cohort", "industry-based" # positive trend observed, p=0.01, no CIs present
                           "Huebner et al. (2004)", 0.81, 0.69, 0.94, 170, "cohort", "industry-based",
                           "Jarvholm et al. (1997)", 0.56, 0.31, 0.92, 11, "cohort", "industry-based",
                           "Lewis et al. (2003)_highest_exp_group", 3.3, 1.4, 7.7, 7, "cohort", "industry-based",
                           "Lynge et al. (1997)_gaso workers_SIR", 1.3, 1.1, 1.4, 208, "cohort", "industry-based",
                           "Tsai et al. (2003)_SMR_approx.", 0.73, 0.53, 0.97, 46, "cohort", "industry-based",
                           "Wong et al. (2001)_SMR_approx.", 0.76, 0.57, 1.0, 52, "cohort", "industry-based",
                           "Yin et al. (1996)", 1.4, 1.0, 2.0, 115, "cohort", "industry-based"
                           )



```


```{r}

alternative_dat3 <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,
                           # "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", "industry-based",
                           # "Collins et al. (2003)_median", 1.3, 1.0, 1.8, 162, "cohort", "industry-based",
                           # "Sorahan et al. (2005)", 1.19, 1.06, 1.34, 293, "cohort", "industry-based",
                           # "Wong et al. (1987)", 1.12, 0.9, 1.39, 86, "cohort", "industry-based",
                           # # "Wong et al. (1993)_land_gaso", 0.66, 0.57, 0.77, 165, "cohort", "industry-based", # excluded b/c same study
                           # "Wong et al. (1993)_marine_gaso", 1.07, 0.94, 1.21, 208, "cohort", "industry-based",
                           "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", "industry-based",
                           # "Koh et al. (2011)", 0.22, 0.03, 0.78, 5, "cohort", "industry-based",
                           ##### following general population-based cohorts
                           # "Bove et al. (2014)_Lejeune", 0.92, 0.8, 1.04, 237, "cohort", "population-based",
                           # "Gérin et al. (1998)", 1.2, 0.7, 1.9, 27, "case-control", "population-based",
                           # "Villeneuve et al. (2014)", 1.84, 1.26, 2.68, 445, "case-control", "population-based",
                           # "Yuan et al. (2014)", 1.10, 0.44, 2.78, 19, "case-control", "population-based",
                           ##### new evidence after the monograph
                           # "Warden et al. (2017)", 1.35, 0.99, 1.84, 652, "case-control", "population-based",
                           # "Cheng et al. (2022)", 1.17, 1.02, 1.34, 2796, "case-control", "population-based",
                           # "Babigumira et al. (2023)_confer.abs", 1.47, 0.88, 2.23, 399, "cohort", "industry-based",
                           ##### possible environmental studies
                           #"Winters et al. (2014)_self-report", 1.24, 0.84, 1.79, 38, "case-control", "population-based",
                           #### add our synergy study,
                           "Wan et al. (2023)", 1.17, 1.10, 1.24, 12329, "case-control", "population-based",
                           #### studies outside of IARC Monograph
                           # "Bertazzi et al. (1989)_refinery_SMR_approx.", 1.22, 0.82, 1.75, 29, "cohort" , "industry-based",
                           # "Bond et al. (1986)", 0.99, 0.59, 1.57, 18, "cohort", "industry-based",
                           # "Rushton et al. (1993)_refinery_SMR_approx.", 1.15, 1.01, 1.3, 254, "cohort", "industry-based",
                           # "Consonni et al. (1999)_refinery_SMR_approx.", 1.07, 0.79, 1.43, 46, "cohort", "industry-based", 
                           # # "Ferreccio et al. (2013)", 8.7, 0.63, 120, 2, "case-control", "population-based", ### Arsenic-focused, NA for benzene
                           # "Gun et al. (2006)_SIR", 0.69, 0.57, 0.83, 113, "cohort", "industry-based",
                           # # "Hayes et al. (1996)_no CIs present", 1.4, 1.4, 1.4, "cohort", "industry-based" # positive trend observed, p=0.01, no CIs present
                           # "Huebner et al. (2004)", 0.81, 0.69, 0.94, 170, "cohort", "industry-based",
                           # "Jarvholm et al. (1997)", 0.56, 0.31, 0.92, 11, "cohort", "industry-based",
                           # "Lewis et al. (2003)_highest_exp_group", 3.3, 1.4, 7.7, 7, "cohort", "industry-based",
                           # "Lynge et al. (1997)_gaso workers_SIR", 1.3, 1.1, 1.4, 208, "cohort", "industry-based",
                           # "Tsai et al. (2003)_SMR_approx.", 0.73, 0.53, 0.97, 46, "cohort", "industry-based",
                           # "Wong et al. (2001)_SMR_approx.", 0.76, 0.57, 1.0, 52, "cohort", "industry-based",
                           # "Yin et al. (1996)", 1.4, 1.0, 2.0, 115, "cohort", "industry-based"
                           "Mattei et al. (2016)", 1.01, 0.59, 1.71, 106, "case-control", "population-based",
                           "McHugh et al. (2010)", 1.13, 0.69, 1.86, 38, "case-control", "population-based",
                           "Greenland et al. (1994)", 0.58, 0.31, 1.07, -99999, "case-control", "industry-based",
                           "Babigumira et al. (2023)", 1.51, 0.93, 2.47, -9999, "cohort", "industry-based"
                           )



```


```{r}

# with alternative table
metagen2 <- metagen(data = alternative_dat3,
                   TE = log(alternative_dat3$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = T, 
                   random = T,
                   method.tau = "REML",
                   lower = log(alternative_dat3$lower_ci),
                   upper = log(alternative_dat3$upper_ci),
                   hakn = TRUE,
                   # subgroup = type
                   )

# require(grid)

forest(metagen2, xlim = c(0.5,3), pooled.totals = T, subgroup = F,  layout = "RevMan5", comb.fixed = T)
# grid.text("Meta-analysis of ever-benzene exposure on lung cancer risk for all studies included in the IARC Monograph on Benzene, stratified by population types", .5, 0.96, gp=gpar(cex=1.2))


```



```{r try meta-reg with studies with CIs available}


metagen <- metagen(data = dat_with_ci,
                   TE = log(dat_with_ci$adjrr),
                   studlab = Authors,
                   sm = "RR",
                   fixed = T, 
                   random = T,
                   method.tau = "REML",
                   lower = dat_with_ci$'CI lower bound',
                   upper = dat_with_ci$'CI upper bound',
                   hakn = TRUE,
                   cluster = ID)

# result from cumulative scale exposure does not mean anything here
# metagen


# incorporate the exposure data, using the mean value in each exposure category as the exposure indicator
exp_ind <- c(5, 5, 1.25, 16.25, 30, 4.6, 10)
exp_ind_jitter <- jitter(exp_ind, factor = 5) # add slight variablity

# run meta-regressio
m.gen.reg <- metareg(metagen, ~exp_ind_jitter)
m.gen.reg


bubble(m.gen.reg, studlab = T, regline = T)


```

Try plotting the linear association without considering meta-regression model.

```{r}
# employ the median value in each exposure category (ppm-year); note that ppm-month is further divided by 12, and the all category (ever exposure) employs the median value of the median valus from all available categories
require(lme4)

dat <- dat[-6,]

exp_ind2 <- c(90, 449.5, 719+449.5, 5, 5, 1.25, 32.5/2, 30+32.5/2, 4.6 , 0, 5, 20, 70, 250, 550, 250/12, 750/12, 1500/12, median(c(250/12, 750/12, 1500/12)), 250/12, 750/12, 1500/12, median(c(250/12, 750/12, 1500/12)))

hist(exp_ind2, breaks = 100) # fits the general exposure distribution

# we also add some spasity of the exposure data
exp_ind2_jitter <- jitter(exp_ind2, factor = 5)

# plot(exp_ind2_jitter , dat$adjrr)
# abline(lm(dat$adjrr ~ exp_ind2_jitter), col = 'red')

# here we control for the number of cases in the regression
# summary(lm(dat$adjrr ~ exp_ind2_jitter + dat$Cases))
# 
# # refit a mixed model where random slope is allowed
# fit2 <- lmer(as.numeric(dat$adjrr) ~ exp_ind2_jitter + (exp_ind2_jitter | ID), 
#              data = dat)

# plot(fit2)
# summary(fit2)
# # not a slight singal has been picked up here

ggplot(mapping = aes(x = exp_ind2_jitter, y = as.numeric(dat$adjrr))) +
  geom_smooth(method = lm, se = T, na.rm = T, col = 'red', linetype = 'dashed', size = 0.5) + 
  geom_point(na.rm =  T)


```

 Summary 

The meta-regression was based on three cohort studies (Sorahan, Lewis, and Gun). The p.value for such possible effect of exposure on lung cancer mortality/incidence is 0.5069,	95% CI (-0.0298	- 0.0519), indicating basically no evidence of the effect on lung cancer. For other studies that did not include standard errors in their results, I fitted a linear model by controlling for the number of cases in each study, the effect remains non-significant (p.value=0.9319).  






```{r import meta-data}

data <- read_xlsx("O:/DGK/IRAS/EEPI/Projects/Synergy/Benzene/result/sensitivity/Benzene lung cancer cohort data_roberto.xlsx")

# filter out the useful rows
dat <-  data[grep("Cum" , data$`Exposure category`, ignore.case = T), ]

# plot the risk
plot(dat$adjrr)
abline(h = 1, col = 'red') ## sparely distributed


```

```{r include=FALSE}

# only extract studies with available CIs
dat_with_ci <- subset(dat, dat$`CI lower bound` > 0)

dat_with_ci <- dat_with_ci %>% 
  mutate(across(where(is.character), as.numeric)) %>% 
  select(Authors, adjrr, 'CI lower bound', 'CI upper bound', ID)

dat_with_ci <- rbind(dat_with_ci, c("CAMP 2015", 1.5, 1.2, 1.7, 4))
dat_with_ci <- dat_with_ci %>% 
  mutate(across(where(is.character), as.numeric))


```

################################### Major change #################

Only focus on the studies being included in the IARC rather than all the studies collected by Roberto. 

```{r}

alternative_dat <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design,
                           # "Bond et al. (1986)", 0.99, 0.59, 1.57, 18, "cohort",
                           "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", 
                           "Collins et al. (2003)_median", 1.3, 1.0, 1.8, 162, "cohort", 
                           "Sorahan et al. (2005)", 1.19, 1.06, 1.34, 293, "cohort", 
                           "Wong et al. (1987)", 1.12, 0.9, 1.39, 86, "cohort", 
                           "Wong et al. (1993)_land_gaso", 0.66, 0.57, 0.77, 165, "cohort", 
                           "Wong et al. (1993)_marine_gaso", 1.07, 0.94, 1.21, 208, "cohort", 
                           "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", 
                           "Koh et al. (2011)", 0.22, 0.03, 0.78, 5, "cohort",
                           ##### following general population-based cohorts
                           "Bove et al. (2014)_Lejeune", 0.92, 0.8, 1.04, 237, "cohort", 
                           "Gérin et al. (1998)", 1.2, 0.7, 1.9, 27, "case-control",
                           "Villeneuve et al. (2014)", 1.84, 1.26, 2.68, 445, "case-control",
                           "Yuan et al. (2014)", 1.10, 0.44, 2.78, 19,  "case-control",
                           ##### new evidence after the monograph
                           "Warden et al. (2017)", 1.35, 0.99, 1.84, 652, "case-control",
                           "Cheng et al. (2020)_confer.abs", 1.18, 1.03, 1.35, 2796, "case-control",
                           # "Babigumira et al. (2023)_confer.abs", 1.47, 0.88, 2.23, 399, "cohort",
                           )

alternative_dat <- cbind(c(rep("industry-based", 8), rep("population-based", 4)),alternative_dat)
colnames(alternative_dat)[1] <- "type"

```

```{r}

# with alternative table
metagen <- metagen(data = alternative_dat,
                   TE = log(alternative_dat$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = T, 
                   random = T,
                   method.tau = "REML",
                   lower = log(alternative_dat$lower_ci),
                   upper = log(alternative_dat$upper_ci),
                   hakn = TRUE,
                   subgroup = type)

require(grid)

forest(metagen, xlim = c(0.5,3), pooled.totals = T, subgroup = T,  layout = "RevMan5", comb.fixed = FALSE)
# grid.text("Meta-analysis of ever-benzene exposure on lung cancer risk for all studies included in the IARC Monograph on Benzene, stratified by population types", .5, 0.96, gp=gpar(cex=1.2))


```



```{r}

# looking also for the publication bias

col.contour = c("gray75", "gray85", "gray95")

funnel.meta(ma_ever,
            # xlim = c(0, 1),
            contour.levels = c(0.9, 0.95, 0.99),
            col.contour = col.contour,
            studlab = T, pch = 21, cex = 1.3, bg = "red2", col.random = "black",
            cex.studlab = 0.6, pos.studlab = "4"
            )
legend(x = 2.4, y = 0.01, 
       legend = c("p < 0.1", "p < 0.05", "p < 0.01"),
       fill = col.contour,
       cex = 0.55)

## egger test

# if (!require("remotes")) {
#   install.packages("remotes")
# }
# remotes::install_github("MathiasHarrer/dmetar")

require(dmetar)

ma_ever <- metagen(data = dat_ever,
                   TE = log(dat_ever$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_ever$lower_ci),
                   upper = log(dat_ever$upper_ci),
                   hakn = TRUE
                   # need to remove subgroup for test of small-study effect
                   #subgroup = comp_grp #vary this so various stratification can be made
                   )



eggers.test(ma_ever)

metabias(ma_ever, method.bias = "linreg")

```


```{r}

# duval & tweedie trim and fill method

tf <- trimfill(ma_ever)
summary(tf)
tf_no_outlier <- trimfill(update.meta(ma_ever,
                                      ))
metabias(ma_ever)

```


```{r}

## AML positive study population


dat_ever <- tribble(~study, ~rr, ~lower_ci, ~upper_ci, ~cases, ~design, ~type,  ~comp_grp, ~study_type, 
               # "Wong et al. (1987)", 1.29, 1.00, 1.65, 18, "cohort", "industry-based", "external", "cohort studies with external comparison", 
               # for collins (2003), the sum o/e is calculated (252/191.8) to obtain ever_exp estimates
               "Collins et al. (2003)", 1.31, 1.16, 1.48, 252, "cohort", "industry-based", "external", "cohort studies with external comparison", 
               "Sorahan et al. (2005)", 1.19, 1.06, 1.34, 293, "cohort", "industry-based", "external", "cohort studies with external comparison", 
               # "Hoshuyama et al. (2006)", 1.04, 1.00, 1.08, 11, "cohort", "industry-based", "internal", "cohort studies with internal comparison",
               # "Koh et al. (2011)", 0.35, 0.11, 0.83, 6, "cohort", "industry-based", "external", "cohort studies with external comparison", 
               # "Koh et al. (2014)", 0.73, 0.24, 1.71, 5, "cohort", "industry-based", "external", "cohort studies with external comparison", 
               "Linet et al. (2015)", 1.5, 1.2, 1.9, 351, "cohort", "industry-based", "internal", "cohort studies with internal comparison",
               # "Collins et al. (2015)", 1.05, 0.89, 1.24, 146, "cohort", "industry-based", "external", "cohort studies with external comparison", 
               # for Babigumira 2023, fixed-effect MA for three exp categories was used to estimate the ever_exp est.
               "Babigumira et al. (2023)", 1.29, 0.98, 1.71, 292, "cohort", "industry-based", "internal", "cohort studies with internal comparison",
               # "Wan et al. (2023)", 1.17, 1.10, 1.24, 5838, "case-control", "population-based", "internal",  "case-control",
               # for mattei 2016, fixed-effect MA for three exp categories was used to estimate the ever_exp est.
               # "Mattei et al. (2016)", 0.95, 0.66, 1.36, 343, "case-control", "population-based", "internal", "case-control",
               # "McHugh et al. (2010)", 1.13, 0.69, 1.86, 38, "case-control", "population-based", "internal","case-control",
               # "Greenland et al. (1994)", 0.58, 0.31, 1.07, -99999, "case-control", "industry-based", "internal", "case-control")
)


ma_ever <- metagen(data = dat_ever,
                   TE = log(dat_ever$rr),
                   studlab = study,
                   sm = "RR",
                   fixed = F, 
                   random = T,
                   method.tau = "REML",
                   lower = log(dat_ever$lower_ci),
                   upper = log(dat_ever$upper_ci),
                   hakn = TRUE,
                   # subgroup = study_type #vary this so various stratification can be made
                   )


forest(ma_ever, xlim = c(0.5,2.5), pooled.totals = F,  layout = "RevMan5", random = T, weight.study = "random", common = F, subgroup = F)





```


DO NOT RUN, only for testing lm (unable to fit, singularity)
```{r}

#try traditional lme4
require(lme4)
require(lmerTest)
lm4_fit <- lmerTest::lmer(logrr ~ exp + (exp|study), data = dat_metareg)
summary(lm4_fit)



pred_intervals <- predictInterval(lm4_fit, newdata, which = "fixed", level = 0.95, n.sims = 1000) %>% 
  cbind(newdata) 
colnames(pred_intervals)[4] <- "exp"


# Plot the data with error bars, log-linear fit, and SE
ggplot(dat_metareg, aes(x = exp, y = exp(logrr))) +
  geom_point(aes(shape = study), size = 2.5, show.legend = T) +
  scale_color_bmj()+
  # scale_color_manual(values = c("red", "blue", "black"))  +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", linewidth = 0.3) +
  geom_line(data = pred_intervals, aes(x = exp, y = exp(fit)), color = "blue") +
  geom_ribbon(data = pred_intervals, aes(x = exp, ymin = exp(lwr), ymax = exp(upr), y = exp(fit)), alpha = 0.1) +  
  
  # geom_line(data = pred_val, aes(x = `rcs(exp, knots)exp`, y = pred), color = "blue") +
  # geom_ribbon(data = pred_val, aes(x = `rcs(exp, knots)exp`, ymin = ci.lb, ymax = ci.ub, y = pred), alpha = 0.1) +  

    labs(x = "Benzene Exposure (ppm-year)", y = "Relative Risk (RR)", shape = "Study") +
  theme_bw()


```


```{r}
#archive
# require(lme4)
# require(splines)
# 
# ggplot(dat_metareg, aes(x = exp, y = RR, shape = study, fill = study)) +
#   geom_point(size = 3) +
#   geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
#   scale_y_log10() +
#   labs(x = "Exposure (exp)", y = "Relative Risk (RR)", shape = "Study") +
#   theme_gray() 
# 
# model <- lmer(log(RR) ~ exp + 1 | study, data = dat_metareg)
# 
# # model <- lmer(RR ~ poly(exp, 3) + (1 | study), data = dat_metareg)
# 
# # Create prediction data
# new_data <- dat_metareg %>%
#   group_by(study) %>%
#   expand(exp = seq(min(exp), max(exp), length.out = 500)) %>% 
#   ungroup()
# 
# 
# new_data <- dat_metareg %>%
#   expand(exp = seq(min(exp), max(exp), length.out = 100)) %>%
#   mutate(pred_log_RR = predict(model, newdata = ., re.form = NA),
#          se = predict(model, newdata = ., se.fit = TRUE, re.form = NA)$se.fit,
#          pred_RR = exp(pred_log_RR),
#          lower_RR = exp(pred_log_RR - 1.96 * se),
#          upper_RR = exp(pred_log_RR + 1.96 * se))
# 
# # Plot the data with error bars, log-linear fit, and SE
# ggplot(dat_metareg, aes(x = exp, y = RR)) +
#   geom_point(aes(shape = study), size = 3) +
#   geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.1) +
#   geom_smooth(data = new_data, aes(y = pred_RR), color = "blue") +
#   # geom_ribbon(data = new_data, aes(ymin = lower_RR, ymax = upper_RR), alpha = 0.2) +
#   # scale_x_log10() +
#   labs(x = "Exposure (exp)", y = "Relative Risk (RR)", shape = "Study") +
#   theme_minimal()



```





